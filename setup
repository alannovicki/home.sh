#!/bin/sh
# Author - Alan Novicki (https://github.com/alannovicki)
# Creates symlinks from $HOME to the existing dotfiles in the ./dotfiles/
# subdirectory of this repo, and runs the scripts in ./exec/setup

USER_HOME=$HOME
SCRIPT_HOME=$(cd -P -- "$(dirname -- "$0")" && pwd -P)
DOTFILE_ARCHIVE=$USER_HOME/dotfile_archive_at_`date +%s`_by_$$/
source $SCRIPT_HOME/shell-util/iowrapper.sh

symlink_files() {
  for file in `ls -A $SCRIPT_HOME/dotfiles`; do
    # ignore ".ignore" files:
    [[ $file == *.ignore ]] && continue

    dotfile_name=`basename $file`
    new_dotfile=$USER_HOME/$dotfile_name

    printf_bold "$dotfile_name:\n"

    [ -f $new_dotfile ] &&
    yesno "Archive original $new_dotfile?" &&
    ([ -d $DOTFILE_ARCHIVE ] || mkdir $DOTFILE_ARCHIVE) &&
    mv $1 $DOTFILE_ARCHIVE

    printf "Symlinking... "
    ln -s -v $file $new_dotfile
    printf "\n"
  done
}

run_setup_scripts() {
  for file in `ls -A $SCRIPT_HOME/exec/setup`; do
    # ignore ".ignore" files:
    [[ $file == *.ignore ]] && continue
    # Only execute if it's an executable file and the user authorizes it
    [[ ! -x "$file" ]] && printf_yellow "Ignoring unexecutable $file" && continue
    yesno "Run $file?" && "$file"
  done
}

print_archive_path_if_exists() {
  [ -d $DOTFILE_ARCHIVE ] && printf_green "Archived files can be found at $DOTFILE_ARCHIVE"
}

symlink_files
run_setup_scripts
echo "\n\n"
print_archive_path_if_exists
printf_bold "\nsetup: âœ” done\n"
exit 0
